{% extends "base.html" %}

{% block title %}Admin Panel - {{ site_settings.company_name }}{% endblock %}

{% block extra_css %}
<style>
.role-badges {
    line-height: 1.8;
}

.role-badges .badge {
    font-size: 0.8rem;
    margin-bottom: 2px;
}

.modal-lg {
    max-width: 800px;
}

.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.card {
    border: none !important;
    border-radius: 15px;
    overflow: hidden;
}

.card-header {
    border-radius: 0 !important;
    border: none !important;
    margin: 0 !important;
    padding: 1rem 1.25rem !important;
}

.section-divider {
    margin: 4rem 0 3rem 0;
    position: relative;
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 20%, rgba(255, 255, 255, 0.6) 50%, rgba(255, 255, 255, 0.3) 80%, transparent 100%);
    overflow: hidden;
}

.section-divider::before {
    content: '';
    position: absolute;
    top: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 8px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
    border-radius: 50px;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
    animation: pulse 2s ease-in-out infinite alternate;
}

@keyframes pulse {
    0% {
        transform: translateX(-50%) scale(1);
        opacity: 0.8;
    }
    100% {
        transform: translateX(-50%) scale(1.1);
        opacity: 1;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2 class="text-white mb-0">
                <i class="fas fa-tachometer-alt me-2"></i>Admin Panel
            </h2>
            {% if current_user.is_admin %}
            <a href="{{ url_for('admin_settings') }}" class="btn btn-light">
                <i class="fas fa-palette me-2"></i>Site Settings
            </a>
            {% endif %}
        </div>
    </div>

    <!-- User Management Section -->
    {% if current_user.is_admin or current_user.can_manage_users %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>User Management</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Username</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Roles & Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.full_name }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.created_at.strftime('%d/%m/%Y') if user.created_at else 'N/A' }}</td>
                                    <td>{{ user.last_login.strftime('%d/%m/%Y %H:%M') if user.last_login else 'Never' }}</td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Disabled</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="role-badges">
                                            {% if user.is_admin %}
                                                <span class="badge bg-danger me-1"><i class="fas fa-crown me-1"></i>Admin</span>
                                            {% endif %}
                                            {% if user.can_manage_users %}
                                                <span class="badge bg-info me-1"><i class="fas fa-users me-1"></i>User Manager</span>
                                            {% endif %}
                                            {% if user.can_view_analytics %}
                                                <span class="badge bg-success me-1"><i class="fas fa-chart-bar me-1"></i>Analytics</span>
                                            {% endif %}
                                            {% if user.can_view_logs %}
                                                <span class="badge bg-warning text-dark me-1"><i class="fas fa-clipboard-list me-1"></i>Logs</span>
                                            {% endif %}
                                            {% if user.is_partner %}
                                                <span class="badge me-1" style="background-color: #6f42c1;"><i class="fas fa-handshake me-1"></i>Partner</span>
                                            {% endif %}
                                            {% if not user.is_admin and not user.can_manage_users and not user.can_view_analytics and not user.can_view_logs and not user.is_partner %}
                                                <span class="badge bg-secondary">Standard User</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if current_user.is_admin %}
                                                <button class="btn btn-sm btn-outline-info permissions-btn"
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.full_name }}"
                                                        data-user-email="{{ user.email }}"
                                                        data-is-admin="{{ user.is_admin|lower }}"
                                                        data-can-manage-users="{{ user.can_manage_users|lower }}"
                                                        data-can-view-analytics="{{ user.can_view_analytics|lower }}"
                                                        data-can-view-logs="{{ user.can_view_logs|lower }}"
                                                        data-is-partner="{{ user.is_partner|lower }}"
                                                        title="Manage Permissions">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                            {% endif %}
                                            {% if user.email != current_user.email %}
                                                <button class="btn btn-sm btn-outline-primary" onclick="toggleUserStatus({{ user.id }})" title="Enable/Disable User">
                                                    <i class="fas fa-power-off"></i>
                                                </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="showPasswordResetModal({{ user.id }}, '{{ user.email }}')" title="Reset Password">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Analytics Section -->
    {% if current_user.is_admin or current_user.can_view_analytics %}
    {% if current_user.is_admin or current_user.can_manage_users %}
    <div class="section-divider"></div>
    {% endif %}
    <div class="row mb-3">
        <div class="col-12">
            <h4 class="text-white mb-0">
                <i class="fas fa-chart-line me-2"></i>Analytics
            </h4>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Quote Analytics</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Quotes Created</th>
                                    <th>Total Days Estimated</th>
                                    <th>Last Quote</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in quote_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ stat.full_name }}</strong><br>
                                        <small class="text-muted">{{ stat.username }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary fs-6">{{ stat.quote_count or 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info fs-6">{{ "%.1f"|format(stat.total_days or 0) }} days</span>
                                    </td>
                                    <td>{{ stat.last_quote.strftime('%d/%m/%Y') if stat.last_quote else 'Never' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i>Login Activity (30 Days)</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Login Count</th>
                                    <th>Last Login</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in login_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ stat.full_name }}</strong><br>
                                        <small class="text-muted">{{ stat.username }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-success fs-6">{{ stat.login_count }}</span>
                                    </td>
                                    <td>{{ stat.last_login.strftime('%d/%m/%Y %H:%M') if stat.last_login else 'Never' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Motivational Quotes Management Section -->
    {% if current_user.is_admin %}
    <div class="section-divider"></div>
    <div class="row mb-3">
        <div class="col-12">
            <h4 class="text-white mb-0">
                <i class="fas fa-quote-left me-2"></i>Motivational Quotes Management
            </h4>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Manage Quotes</h5>
                        <button class="btn btn-sm btn-success" onclick="showAddQuoteModal()">
                            <i class="fas fa-plus me-1"></i>Add New Quote
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="quotesTable">
                            <thead>
                                <tr>
                                    <th style="width: 40%">Quote</th>
                                    <th style="width: 20%">Author</th>
                                    <th style="width: 15%">Status</th>
                                    <th style="width: 15%">Created</th>
                                    <th style="width: 10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotesTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading quotes...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Quote Modal -->
    <div class="modal fade" id="quoteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quoteModalTitle">Add New Quote</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quoteForm">
                        <input type="hidden" id="quoteId">
                        <div class="mb-3">
                            <label for="quoteText" class="form-label">Quote Text</label>
                            <textarea class="form-control" id="quoteText" rows="3" maxlength="500" required></textarea>
                            <small class="text-muted">Maximum 500 characters</small>
                        </div>
                        <div class="mb-3">
                            <label for="quoteAuthor" class="form-label">Author</label>
                            <input type="text" class="form-control" id="quoteAuthor" maxlength="100" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveQuote()">Save Quote</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Audit Logs Section -->
    {% if current_user.is_admin or current_user.can_view_logs %}
    {% if current_user.is_admin or current_user.can_manage_users or current_user.can_view_analytics %}
    <div class="section-divider"></div>
    {% endif %}
    <div class="row mb-3">
        <div class="col-12">
            <h4 class="text-white mb-0">
                <i class="fas fa-clipboard-list me-2"></i>Audit Logs
            </h4>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-history me-2"></i>Activity Log</h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-light" data-days="1" onclick="filterLogs(1)">1 Day</button>
                            <button type="button" class="btn btn-outline-light active" data-days="3" onclick="filterLogs(3)">3 Days</button>
                            <button type="button" class="btn btn-outline-light" data-days="7" onclick="filterLogs(7)">7 Days</button>
                            <button type="button" class="btn btn-outline-light" data-days="30" onclick="filterLogs(30)">30 Days</button>
                        </div>
                    </div>
                </div>
                <div class="card-body" id="logs-loading" style="display: none;">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Loading logs...</p>
                    </div>
                </div>
                <div class="card-body" id="logs-content">
                    <div class="table-responsive" style="max-height: 1000px; overflow-y: auto;">
                        <table class="table table-sm table-striped">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th style="width: 140px;">Timestamp</th>
                                    <th style="width: 120px;">User</th>
                                    <th style="width: 180px;">Action</th>
                                    <th>Details</th>
                                    <th style="width: 120px;">IP Address</th>
                                    <th style="width: 180px;">Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_logs %}
                                <tr>
                                    <td><small><strong>{{ log.timestamp.strftime('%d/%m/%Y %H:%M:%S') }}</strong></small></td>
                                    <td>
                                        <strong>{{ log.username or 'Anonymous' }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if log.action == 'LOGIN' %}bg-success
                                            {% elif log.action == 'LOGOUT' %}bg-secondary
                                            {% elif log.action.startswith('ADMIN') or log.action in ['USER_STATUS_CHANGED', 'PERMISSION_CHANGED'] %}bg-danger
                                            {% elif log.action == 'QUOTE_CREATED' %}bg-primary
                                            {% elif log.action in ['PASSWORD_CHANGED', 'EMAIL_UPDATED', 'PROFILE_PICTURE_UPDATED', 'PASSWORD_RESET'] %}bg-info
                                            {% elif log.action in ['ADMIN_PANEL_ACCESS'] %}bg-warning text-dark
                                            {% else %}bg-dark
                                            {% endif %}">
                                            {{ log.action.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td><small>{{ log.details or '-' }}</small></td>
                                    <td><small><code>{{ log.ip_address }}</code></small></td>
                                    <td><small>{{ log.location or '-' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if recent_logs|length == 0 %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No audit logs found.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="passwordResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Reset password for: <strong id="resetUserEmail"></strong></p>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" class="form-control" id="newPassword" required minlength="12">
                    <small class="text-muted">Minimum 12 characters with uppercase, lowercase, number, and special character</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Permissions Management Modal -->
<div class="modal fade" id="permissionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-shield me-2"></i>
                    Manage Permissions: <span id="permissionsUserName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Configure user permissions and access levels. Changes take effect immediately.
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6 class="mb-3">User Information</h6>
                        <div class="mb-3">
                            <strong>Email:</strong> <span id="permissionsUserEmail"></span>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-12">
                        <h6 class="mb-3">Roles & Permissions</h6>
                        
                        <!-- Admin Permission -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <h6 class="mb-1 text-danger">
                                            <i class="fas fa-crown me-2"></i>Administrator
                                        </h6>
                                        <small class="text-muted">Full system access. Can manage users, view analytics, and access audit logs.</small>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="adminToggle" onchange="toggleUserPermission('is_admin', this.checked)">
                                            <label class="form-check-label" for="adminToggle">
                                                <span class="admin-status">Disabled</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Management Permission -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <h6 class="mb-1 text-info">
                                            <i class="fas fa-users me-2"></i>User Manager
                                        </h6>
                                        <small class="text-muted">Can manage user accounts, enable/disable users, and reset passwords.</small>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="userMgmtToggle" onchange="toggleUserPermission('can_manage_users', this.checked)">
                                            <label class="form-check-label" for="userMgmtToggle">
                                                <span class="user-mgmt-status">Disabled</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Permission -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <h6 class="mb-1 text-success">
                                            <i class="fas fa-chart-bar me-2"></i>Analytics Viewer
                                        </h6>
                                        <small class="text-muted">Can view system analytics, user statistics, and performance metrics.</small>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="analyticsToggle" onchange="toggleUserPermission('can_view_analytics', this.checked)">
                                            <label class="form-check-label" for="analyticsToggle">
                                                <span class="analytics-status">Disabled</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Logs Permission -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <h6 class="mb-1 text-warning">
                                            <i class="fas fa-clipboard-list me-2"></i>Audit Logs Viewer
                                        </h6>
                                        <small class="text-muted">Can view audit logs, user activity, and security events.</small>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="logsToggle" onchange="toggleUserPermission('can_view_logs', this.checked)">
                                            <label class="form-check-label" for="logsToggle">
                                                <span class="logs-status">Disabled</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Partner Status -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <h6 class="mb-1" style="color: #6f42c1;">
                                            <i class="fas fa-handshake me-2"></i>Partner
                                        </h6>
                                        <small class="text-muted">Partner users can only access the quote calculator. They cannot see historic quotes or admin features.</small>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="partnerToggle" onchange="toggleUserPermission('is_partner', this.checked)">
                                            <label class="form-check-label" for="partnerToggle">
                                                <span class="partner-status">Disabled</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedUserId = null;

// Test function to verify modals work
function testModal() {
    console.log('Testing modal...');
    const modalElement = document.getElementById('permissionsModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('Test modal shown');
    } else {
        console.error('Modal element not found');
    }
}

// Add event listeners when document is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up event listeners');
    
    // Add click event listeners to all permissions buttons
    const permissionsBtns = document.querySelectorAll('.permissions-btn');
    console.log('Found', permissionsBtns.length, 'permissions buttons');
    
    permissionsBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Permissions button clicked');
            
            const userId = parseInt(this.dataset.userId);
            const userName = this.dataset.userName;
            const userEmail = this.dataset.userEmail;
            const isAdmin = this.dataset.isAdmin === 'true';
            const canManageUsers = this.dataset.canManageUsers === 'true';
            const canViewAnalytics = this.dataset.canViewAnalytics === 'true';
            const canViewLogs = this.dataset.canViewLogs === 'true';
            const isPartner = this.dataset.isPartner === 'true';

            console.log('Button data:', {userId, userName, userEmail, isAdmin, canManageUsers, canViewAnalytics, canViewLogs, isPartner});

            showPermissionsModal(userId, userName, userEmail, isAdmin, canManageUsers, canViewAnalytics, canViewLogs, isPartner);
        });
    });
});

function showPasswordResetModal(userId, userEmail) {
    selectedUserId = userId;
    document.getElementById('resetUserEmail').textContent = userEmail;
    document.getElementById('newPassword').value = '';
    new bootstrap.Modal(document.getElementById('passwordResetModal')).show();
}

async function toggleUserStatus(userId) {
    try {
        const response = await fetch(`/admin/users/toggle/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert(data.error || 'Failed to toggle user status');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function toggleAdminStatus(userId) {
    if (!confirm('Are you sure you want to change this user\'s admin status?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/users/toggle-admin/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert(data.error || 'Failed to toggle admin status');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Permissions Modal Functions
let currentUserId = null;
let currentUserEmail = null;

function showPermissionsModal(userId, userName, userEmail, isAdmin, canManageUsers, canViewAnalytics, canViewLogs, isPartner) {
    console.log('showPermissionsModal called with:', {userId, userName, userEmail, isAdmin, canManageUsers, canViewAnalytics, canViewLogs, isPartner});
    
    currentUserId = userId;
    currentUserEmail = userEmail;
    
    try {
        // Update modal content
        document.getElementById('permissionsUserName').textContent = userName;
        document.getElementById('permissionsUserEmail').textContent = userEmail;
        
        // Set toggle states
        document.getElementById('adminToggle').checked = isAdmin;
        document.getElementById('userMgmtToggle').checked = canManageUsers;
        document.getElementById('analyticsToggle').checked = canViewAnalytics;
        document.getElementById('logsToggle').checked = canViewLogs;
        document.getElementById('partnerToggle').checked = isPartner;

        // Update status labels
        document.querySelector('.admin-status').textContent = isAdmin ? 'Enabled' : 'Disabled';
        document.querySelector('.user-mgmt-status').textContent = canManageUsers ? 'Enabled' : 'Disabled';
        document.querySelector('.analytics-status').textContent = canViewAnalytics ? 'Enabled' : 'Disabled';
        document.querySelector('.logs-status').textContent = canViewLogs ? 'Enabled' : 'Disabled';
        document.querySelector('.partner-status').textContent = isPartner ? 'Enabled' : 'Disabled';
        
        // Disable admin toggle for current user
        const adminToggle = document.getElementById('adminToggle');
        if (currentUserEmail === '{{ current_user.email }}') {
            adminToggle.disabled = true;
            const smallElement = adminToggle.closest('.card-body').querySelector('small');
            if (smallElement) {
                smallElement.innerHTML = '<em class="text-muted">Cannot modify your own admin status</em>';
            }
        } else {
            adminToggle.disabled = false;
            const smallElement = adminToggle.closest('.card-body').querySelector('small');
            if (smallElement) {
                smallElement.textContent = 'Full system access. Can manage users, view analytics, and access audit logs.';
            }
        }
        
        // Show modal
        const modalElement = document.getElementById('permissionsModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log('Modal should be visible now');
        } else {
            console.error('permissionsModal element not found');
        }
    } catch (error) {
        console.error('Error in showPermissionsModal:', error);
        alert('Error opening permissions modal: ' + error.message);
    }
}

async function toggleUserPermission(permission, enabled) {
    const endpoint = permission === 'is_admin' 
        ? `/admin/users/toggle-admin/${currentUserId}` 
        : `/admin/users/toggle-permission/${currentUserId}/${permission}`;
    
    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (response.ok) {
            // Update status label
            const statusMap = {
                'is_admin': '.admin-status',
                'can_manage_users': '.user-mgmt-status',
                'can_view_analytics': '.analytics-status',
                'can_view_logs': '.logs-status',
                'is_partner': '.partner-status'
            };
            
            const statusElement = document.querySelector(statusMap[permission]);
            if (statusElement) {
                statusElement.textContent = enabled ? 'Enabled' : 'Disabled';
            }
            
            // Show success message
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert(data.error || 'Failed to update permission');
            // Revert toggle state
            const toggleId = {
                'is_admin': 'adminToggle',
                'can_manage_users': 'userMgmtToggle',
                'can_view_analytics': 'analyticsToggle',
                'can_view_logs': 'logsToggle'
            };
            document.getElementById(toggleId[permission]).checked = !enabled;
        }
    } catch (error) {
        alert('Error: ' + error.message);
        // Revert toggle state
        const toggleId = {
            'is_admin': 'adminToggle',
            'can_manage_users': 'userMgmtToggle',
            'can_view_analytics': 'analyticsToggle',
            'can_view_logs': 'logsToggle'
        };
        document.getElementById(toggleId[permission]).checked = !enabled;
    }
}

async function resetPassword() {
    const newPassword = document.getElementById('newPassword').value;
    
    if (newPassword.length < 12) {
        alert('Password must be at least 12 characters');
        return;
    }
    
    try {
        const response = await fetch(`/admin/users/reset-password/${selectedUserId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ password: newPassword })
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('Password reset successfully');
            bootstrap.Modal.getInstance(document.getElementById('passwordResetModal')).hide();
        } else {
            alert(data.error || 'Failed to reset password');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Logs filtering functionality
let currentLogFilter = 3; // Default to 3 days

async function filterLogs(days) {
    currentLogFilter = days;
    
    // Update button states
    document.querySelectorAll('[data-days]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-days="${days}"]`).classList.add('active');
    
    // Show loading
    document.getElementById('logs-content').style.display = 'none';
    document.getElementById('logs-loading').style.display = 'block';
    
    try {
        const response = await fetch(`/admin/logs/${days}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (response.ok) {
            updateLogsTable(data.logs);
        } else {
            console.error('Failed to fetch logs:', data.error);
            alert('Failed to load logs: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error fetching logs:', error);
        alert('Error loading logs: ' + error.message);
    } finally {
        // Hide loading
        document.getElementById('logs-loading').style.display = 'none';
        document.getElementById('logs-content').style.display = 'block';
    }
}

function updateLogsTable(logs) {
    const tableBody = document.querySelector('#logs-content tbody');
    const noDataDiv = document.querySelector('#logs-content .text-center');
    
    if (logs && logs.length > 0) {
        // Hide no data message
        if (noDataDiv) noDataDiv.style.display = 'none';
        
        // Update table
        tableBody.innerHTML = logs.map(log => {
            const timestamp = new Date(log.timestamp).toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            let badgeClass = 'bg-dark';
            if (log.action === 'LOGIN') badgeClass = 'bg-success';
            else if (log.action === 'LOGOUT') badgeClass = 'bg-secondary';
            else if (log.action.startsWith('ADMIN') || ['USER_STATUS_CHANGED', 'PERMISSION_CHANGED'].includes(log.action)) badgeClass = 'bg-danger';
            else if (log.action === 'QUOTE_CREATED') badgeClass = 'bg-primary';
            else if (['PASSWORD_CHANGED', 'EMAIL_UPDATED', 'PROFILE_PICTURE_UPDATED', 'PASSWORD_RESET'].includes(log.action)) badgeClass = 'bg-info';
            else if (log.action === 'ADMIN_PANEL_ACCESS') badgeClass = 'bg-warning text-dark';
            
            return `
                <tr>
                    <td><small><strong>${timestamp}</strong></small></td>
                    <td><strong>${log.username || 'Anonymous'}</strong></td>
                    <td>
                        <span class="badge ${badgeClass}">
                            ${log.action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                        </span>
                    </td>
                    <td><small>${log.details || '-'}</small></td>
                    <td><small><code>${log.ip_address}</code></small></td>
                    <td><small>${log.location || '-'}</small></td>
                </tr>
            `;
        }).join('');
    } else {
        // Show no data message
        if (noDataDiv) {
            noDataDiv.style.display = 'block';
        } else {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                        No logs found for the selected time period.
                    </td>
                </tr>
            `;
        }
    }
}

// Initialize logs on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load initial logs (3 days by default)
    filterLogs(3);
    
    // Load quotes if admin
    if (document.getElementById('quotesTable')) {
        loadQuotes();
    }
});

// Quotes Management Functions
function loadQuotes() {
    fetch('/admin/quotes')
        .then(response => response.json())
        .then(quotes => {
            const tbody = document.getElementById('quotesTableBody');
            
            if (quotes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            No quotes found. Click "Add New Quote" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = quotes.map(quote => `
                <tr>
                    <td>
                        <div class="quote-preview" style="max-height: 60px; overflow: hidden;">
                            "${quote.quote_text.length > 80 ? quote.quote_text.substring(0, 80) + '...' : quote.quote_text}"
                        </div>
                    </td>
                    <td><strong>${quote.author}</strong></td>
                    <td>
                        <span class="badge ${quote.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${quote.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td><small>${quote.created_at}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="editQuote(${quote.id}, '${quote.quote_text.replace(/'/g, "\\'")}', '${quote.author}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-${quote.is_active ? 'warning' : 'success'} btn-sm" 
                                    onclick="toggleQuoteStatus(${quote.id})" 
                                    title="${quote.is_active ? 'Deactivate' : 'Activate'}">
                                <i class="fas fa-${quote.is_active ? 'toggle-off' : 'toggle-on'}"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteQuote(${quote.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading quotes:', error);
            document.getElementById('quotesTableBody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Error loading quotes
                    </td>
                </tr>
            `;
        });
}

function showAddQuoteModal() {
    document.getElementById('quoteModalTitle').textContent = 'Add New Quote';
    document.getElementById('quoteId').value = '';
    document.getElementById('quoteText').value = '';
    document.getElementById('quoteAuthor').value = '';
    new bootstrap.Modal(document.getElementById('quoteModal')).show();
}

function editQuote(id, quoteText, author) {
    document.getElementById('quoteModalTitle').textContent = 'Edit Quote';
    document.getElementById('quoteId').value = id;
    document.getElementById('quoteText').value = quoteText;
    document.getElementById('quoteAuthor').value = author;
    new bootstrap.Modal(document.getElementById('quoteModal')).show();
}

function saveQuote() {
    const id = document.getElementById('quoteId').value;
    const quoteText = document.getElementById('quoteText').value.trim();
    const author = document.getElementById('quoteAuthor').value.trim();
    
    if (!quoteText || !author) {
        alert('Please fill in both quote text and author fields.');
        return;
    }
    
    const url = id ? `/admin/quotes/edit/${id}` : '/admin/quotes/add';
    const data = { quote_text: quoteText, author: author };
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('quoteModal')).hide();
            loadQuotes();
        } else {
            alert(result.error || 'Error saving quote');
        }
    })
    .catch(error => {
        console.error('Error saving quote:', error);
        alert('Error saving quote');
    });
}

function toggleQuoteStatus(id) {
    fetch(`/admin/quotes/toggle/${id}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadQuotes();
        } else {
            alert('Error updating quote status');
        }
    })
    .catch(error => {
        console.error('Error toggling quote status:', error);
        alert('Error updating quote status');
    });
}

function deleteQuote(id) {
    if (!confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/admin/quotes/delete/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadQuotes();
        } else {
            alert(result.error || 'Error deleting quote');
        }
    })
    .catch(error => {
        console.error('Error deleting quote:', error);
        alert('Error deleting quote');
    });
}
</script>
{% endblock %}